#!/bin/bash

#######################################
# <$1                   : LINENO      #
# <stdin                : input       #
# <../samples/$2        : reference   #
# <../../bin/sealgood   : binary      #
# <../../locale/{fr,es} : locale      #
# >$TMPDIR/$2           : output      #
# >stdout               : test result #
#######################################
mydif(){
  lineno=$1
  shift
  tee "$TMPDIR/$1" |
  diff "$mydir/../samples/$1" - || {
    rc=$?
    printf $'KO %4d %s\n' $lineno "$*"
    echo "!cp $TMPDIR/$1 $mydir/../samples/$1"
    return $rc
  }
  printf $'ok %4d %s\n' $lineno "$*"
}
export -f mydif

export mydir="$(cd "$(dirname "$0")";pwd)"
PATH="$(cd "$mydir/../../bin";pwd):$PATH"
export TMPDIR=$(mktemp -d)
exec {fdtty}</dev/null
export fdtty # neutralise read <&$fdtty
parallel "cd $mydir/../../locale/{}/LC_MESSAGES&& msgfmt -o sealgood.mo sealgood.po" ::: fr es

#########################################################
# help                                                  #
# locale/{{run/fr,data/},{run/es,data/},{run/us,data/}} #
#########################################################
parallel "mydif $LINENO test_help_{} < <(
LANGUAGE={} sealgood help 2>&1)" ::: us es fr

######################################################
# lookup/PEM pubkey                                  #
# inject/PEM pubkey                                  #
# get_payload                                        #
# locale/{{run,data}/fr,{run,data}/es,{run,data}/us} #
######################################################
parallel "mydif $LINENO test_inject_{} < <(
LANGUAGE={} sealgood inject < $mydir/../samples/pempub 2>/dev/null)" ::: us es fr

#################################################################################################
# lookup/PEM pubkey                                                                             #
# clean/PEM pubkey                                                                              #
# locale/run/{fr\ locale/data/{fr,es,us},es\ locale/data/{fr,es,us},us\ locale/data/{fr,es,us}} #
#################################################################################################
parallel "mydif $LINENO test_clean < <(
LANGUAGE={1} sealgood clean < $mydir/../samples/test_inject_{2} 2>/dev/null)" ::: fr es us ::: fr es us

#################################################################################################
# list2tgz                                                                                      #
# lookup/sealgood+PEM pubkey                                                                    #
# clean/PEM pubkey                                                                              #
# locale/run/{fr\ locale/data/{fr,es,us},es\ locale/data/{fr,es,us},us\ locale/data/{fr,es,us}} #
#################################################################################################
parallel --linebuffer "mydif $LINENO test_clean_list_{} < <(( ls $mydir/../samples/test_inject_{fr,es,us} |
LANGUAGE={} sealgood list2tgz clean | tar -zvxOf-) 2>&1)" ::: fr es us

###################################
# list2tgz                        #
# lookup/sealgood+PEM pubkey      #
# date/sealgood+PEM pubkey        #
# clean/sealgood+PEM pubkey       #
# verify/sealgood+PEM pubkey      #
# locale/{run/es,data/{fr,es,us}} #
###################################
mydif $LINENO test_date_pubkey  < <(( ls $mydir/../samples/test_inject_{fr,es,us} |
LANGUAGE=es sealgood list2tgz date verify |
                      tee $TMPDIR/pubkeys.tgz | # garde pour le test suivant
                      tar -zvxOf-) 2>&1 | sed -e 's/\(^MIIV\).*/\1/' -e 's/\(^Time stamp:\).*/\1/' )

########################
# lookup/gzip          #
# inject/gzip          #
# lookup/sealgood+gzip #
# date/sealgood+gzip   #
# clean/sealgood+gzip  #
# verify/sealgood+gzip #
# locale/{run,data}/us #
########################
mydif $LINENO test_date_gzip  < <(( cat $TMPDIR/pubkeys.tgz |
LANGUAGE=us sealgood date verify |
                      tar -zvxOf-) 2>&1 | sed -e 's/\(^MIIV\).*/\1/' -e 's/\(^Time stamp:\).*/\1/' )
